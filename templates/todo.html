{% extends "base.html" %}

{% block content %}
<!-- <div id="countdown"></div>-->

<!-- Add Todo Button -->
<button onclick="openAddTodoModal()" class="add-todo-button">Lisa tegevus</button>

<!-- Tabs for Active, Completed, and Deleted Todos -->
<div class="tabs">
    <button class="tablink active" onclick="openTab(event, 'active-todos')">Aktiivsed tegevused</button>
    <button class="tablink" onclick="openTab(event, 'completed-todos')">Tehtud tegevused</button>
    <button class="tablink" onclick="openTab(event, 'deleted-todos')">Prügikast</button>
</div>

<!-- Filters for Priority and Name -->
<div class="filter-container">
    <label for="priority-filter">Prioriteet:</label>
    <select id="priority-filter" onchange="filterTodos()">
        <option value="all">Kõik</option>
        <option value="high">Kõrge</option>
        <option value="medium">Keskmine</option>
        <option value="low">Madal</option>
    </select>

    <label for="name-filter">Nimi:</label>
    <select id="name-filter" onchange="filterTodos()">
        <option value="all">Kõik</option>
        <option value="Romet">Romet</option>
        <option value="Eliis">Eliis</option>
        <option value="Mõlemale">Mõlemale</option>
    </select>

    <label for="date-filter">Kuupäev:</label>
    <select id="date-filter" onchange="sortTodosByDate()">
        <option value="closest">Lähimad ees</option>
        <option value="furthest">Kaugemad ees</option>
    </select>
</div>

<!-- Active Todos Tab with Bulk Actions -->
<div id="active-todos" class="tabcontent" style="display: block;">
    <div class="bulk-actions">
        <button id="select-all-active" onclick="toggleSelectAll('active')">Vali kõik</button>
        <button onclick="bulkComplete()">Märgi tehtuks</button>
        <button onclick="bulkDelete()">Kustuta valitud</button>
    </div>
    <ul id="todo-list" class="sortable-list">
        {% for todo in todos %}
            <li class="todo-item priority-{{ todo.priority }} {% if is_due_soon(todo.date) %}due-soon{% endif %} {% if is_overdue(todo.date) %}overdue{% endif %}"
                data-id="{{ todo.id }}" data-priority="{{ todo.priority }}" data-due-date="{{ todo.raw_date }}">
                <div class="todo-checkbox">
                    <input type="checkbox" class="todo-select" data-id="{{ todo.id }}">
                </div>
                <div class="todo-content" onclick="openTodoModal('{{ todo.by_who }}', '{{ todo.name }}', '{{ todo.date }}', '{{ todo.description | replace('\n', '\\n') | replace('\r', '') | escape }}', '{{ todo.priority }}')">
                    <span class="by-who"><strong>{{ todo.by_who }}</strong></span>
                    <span class="todo-name"><strong>{{ todo.name }}</strong></span>
                    <span class="due-date">Kunaseks: {{ todo.date }}</span>
                    {% if is_due_soon(todo.date) and not is_overdue(todo.date) %}
                        <span class="deadline-indicator soon">Läheneb</span>
                    {% endif %}
                    {% if is_overdue(todo.date) %}
                        <span class="deadline-indicator overdue">Hilinenud</span>
                    {% endif %}
                </div>
                <div class="handle">☰</div>
                <a href="#" onclick="openEditTodoModal('{{ todo.id }}', '{{ todo.by_who }}', '{{ todo.name }}',
                '{{ todo.date }}', '{{ todo.description }}', '{{ todo.priority }}'); return false;"
                   class="edit-button">✎</a>
                <a href="{{ url_for('todo.complete_todo', id=todo.id, tab='active-todos') }}" class="complete-button">✔</a>
            </li>
        {% endfor %}
    </ul>
</div>

<!-- Completed Todos Tab with Bulk Actions -->
<div id="completed-todos" class="tabcontent">
    <div class="bulk-actions">
        <button id="select-all-completed" onclick="toggleSelectAll('completed')">Vali kõik</button>
        <button onclick="bulkDelete('completed')">Kustuta valitud</button>
    </div>
    <ul>
        {% for todo in completed_todos %}
        <li class="todo-item priority-{{ todo.priority }}">
            <div class="todo-checkbox">
                <input type="checkbox" class="todo-select-completed" data-id="{{ todo.id }}">
            </div>
            <div class="todo-content" onclick="openTodoModal('{{ todo.by_who }}', '{{ todo.name }}', '{{ todo.date }}', '{{ todo.description }}', '{{ todo.priority }}')">
                <span class="by-who">{{ todo.by_who }}</span>
                <span class="todo-name"><strong>{{ todo.name }}</strong></span>
                <span class="due-date">Kunaseks: {{ todo.date }}</span>
            </div>
            <a href="{{ url_for('todo.delete_todo', id=todo.id, tab='completed-todos') }}" class="delete-button">❌</a>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- Deleted Todos Tab with Bulk Actions -->
<div id="deleted-todos" class="tabcontent">
    <div class="bulk-actions">
        <button id="select-all-deleted" onclick="toggleSelectAll('deleted')">Vali kõik</button>
        <button onclick="bulkRestore()">Taasta valitud</button>
        <button onclick="bulkPermanentDelete()">Kustuta jäädavalt</button>
    </div>
    <ul>
        {% for todo in deleted_todos %}
        <li class="todo-item priority-{{ todo.priority }}">
            <div class="todo-checkbox">
                <input type="checkbox" class="todo-select-deleted" data-id="{{ todo.id }}">
            </div>
            <div class="todo-content" onclick="openTodoModal('{{ todo.by_who }}', '{{ todo.name }}', '{{ todo.date }}', '{{ todo.description }}', '{{ todo.priority }}')">
                <span class="by-who">{{ todo.by_who }}</span>
                <span class="todo-name"><strong>{{ todo.name }}</strong></span>
                <span class="due-date">Kunaseks: {{ todo.date }}</span>
            </div>
            <a href="{{ url_for('todo.restore_todo', id=todo.id, tab='deleted-todos') }}" class="restore-button">➕</a>
            <a href="{{ url_for('todo.permanent_delete_todo', id=todo.id, tab='deleted-todos') }}" class="delete-button">❌</a>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- Modal for Viewing Todo Details -->
<div id="todoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header priority-low" id="modalHeader">
            <span id="modalByWho"></span>
            <span id="modalTitle"></span>
            <span id="modalDate"></span>
        </div>
        <div class="modal-body">
            <p id="modalDescription"></p>
        </div>
    </div>
</div>

<!-- Modal for Adding a New Todo -->
<div id="addTodoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddTodoModal()">&times;</span>
        <h2>Lisa uus</h2>
        <form method="POST" action="{{ url_for('todo.todo') }}">
            <input type="text" name="name" placeholder="Pealkiri" required>
            <textarea name="description" placeholder="Kirjeldus"></textarea>
            <input type="date" name="date" required>
            <select name="by_who" required>
                <option value="Romet">Romet</option>
                <option value="Eliis">Eliis</option>
                <option value="Mõlemale">Mõlemad</option>
            </select>
            <select name="priority" required>
                <option value="low">Madal</option>
                <option value="medium">Keskmine</option>
                <option value="high">Kõrge</option>
            </select>
            <button type="submit" class="submit-button">Lisa</button>
        </form>
    </div>
</div>

<!-- Modal for Editing a Todo -->
<div id="editTodoModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditTodoModal()">&times;</span>
        <h2>Muuda tegevust</h2>
        <form method="POST" action="{{ url_for('todo.edit_todo') }}">
            <input type="hidden" id="editTodoId" name="id">
            <input type="text" id="editTodoName" name="name" placeholder="Pealkiri" required>
            <textarea id="editTodoDescription" name="description" placeholder="Kirjeldus"></textarea>
            <input type="date" id="editTodoDate" name="date" required>
            <select id="editTodoByWho" name="by_who" required>
                <option value="Romet">Romet</option>
                <option value="Eliis">Eliis</option>
                <option value="Mõlemale">Mõlemad</option>
            </select>
            <select id="editTodoPriority" name="priority" required>
                <option value="low">Madal</option>
                <option value="medium">Keskmine</option>
                <option value="high">Kõrge</option>
            </select>
            <button type="submit" class="submit-button">Salvesta</button>
        </form>
    </div>
</div>

<!-- Forms for bulk actions -->
<form id="bulk-complete-form" action="{{ url_for('todo.bulk_complete') }}" method="POST" style="display: none;">
    <input type="hidden" name="todo_ids" id="bulk-complete-ids">
</form>

<form id="bulk-delete-form" action="{{ url_for('todo.bulk_delete') }}" method="POST" style="display: none;">
    <input type="hidden" name="todo_ids" id="bulk-delete-ids">
    <input type="hidden" name="source_tab" id="bulk-delete-tab">
</form>

<form id="bulk-restore-form" action="{{ url_for('todo.bulk_restore') }}" method="POST" style="display: none;">
    <input type="hidden" name="todo_ids" id="bulk-restore-ids">
</form>

<form id="bulk-permanent-delete-form" action="{{ url_for('todo.bulk_permanent_delete') }}" method="POST" style="display: none;">
    <input type="hidden" name="todo_ids" id="bulk-permanent-delete-ids">
</form>

<div id="fact-container">
    <div class="facts">
        <div class="fact-text"><p id="fact-text">Loading...</p></div>
    </div>
</div>

<script src="{{ url_for('static', filename='facts.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // JavaScript to handle tab switching
    function openTab(evt, tabName) {
        // Hide all tab content
        var tabcontent = document.getElementsByClassName("tabcontent");
        for (var i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Remove the "active" class from all tab buttons
        var tablinks = document.getElementsByClassName("tablink");
        for (var i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab and add the "active" class to the button
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // JavaScript to handle todo details modal
    function openTodoModal(byWho, title, date, description, priority) {
        document.getElementById('modalByWho').innerText = byWho;
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalDate').innerText = date;
        document.getElementById('modalDescription').innerText = description.replace(/\\n/g, '\n');

        // Set priority background color
        var modalHeader = document.getElementById('modalHeader');
        modalHeader.className = 'modal-header priority-' + priority;

        document.getElementById('todoModal').style.display = 'block';
    }

    // JavaScript to handle add todo modal
    function openAddTodoModal() {
        document.getElementById('addTodoModal').style.display = 'block';
    }

    function closeAddTodoModal() {
        document.getElementById('addTodoModal').style.display = 'none';
    }

    function closeModal() {
        document.getElementById('todoModal').style.display = 'none';
    }

    // JavaScript to handle edit todo modal
    function openEditTodoModal(id, byWho, name, date, description, priority) {
        document.getElementById('editTodoId').value = id;
        document.getElementById('editTodoName').value = name;
        document.getElementById('editTodoDescription').value = description;
        document.getElementById('editTodoDate').value = date;
        document.getElementById('editTodoByWho').value = byWho;
        document.getElementById('editTodoPriority').value = priority;

        document.getElementById('editTodoModal').style.display = 'block';
    }

    function closeEditTodoModal() {
        document.getElementById('editTodoModal').style.display = 'none';
    }

    // Close modal if clicked outside of it
    window.onclick = function(event) {
        var todoModal = document.getElementById('todoModal');
        var addTodoModal = document.getElementById('addTodoModal');
        var editTodoModal = document.getElementById('editTodoModal');
        if (event.target == todoModal) {
            closeModal();
        }
        if (event.target == addTodoModal) {
            closeAddTodoModal();
        }
        if (event.target == editTodoModal) {
            closeEditTodoModal();
        }
    }

    // Filter functionality
    function filterTodos() {
        let selectedPriority = document.getElementById("priority-filter").value;
        let selectedName = document.getElementById("name-filter").value;
        let todos = document.querySelectorAll(".todo-item");

        todos.forEach(todo => {
            let byWho = todo.querySelector(".by-who").textContent.trim();
            let matchesPriority = selectedPriority === "all" || todo.classList.contains("priority-" + selectedPriority);
            let matchesName = selectedName === "all" || byWho === selectedName;

            if (matchesPriority && matchesName) {
                todo.style.display = "flex";
            } else {
                todo.style.display = "none";
            }
        });
    }

    // Date sorting functionality
    function sortTodosByDate() {
        let sortOrder = document.getElementById("date-filter").value;
        let todoList = document.getElementById("todo-list");
        let todos = Array.from(todoList.getElementsByClassName("todo-item"));

        todos.sort((a, b) => {
            let dateA = new Date(a.querySelector(".due-date").textContent.replace("Kunaseks: ", "").trim());
            let dateB = new Date(b.querySelector(".due-date").textContent.replace("Kunaseks: ", "").trim());

            return sortOrder === "closest" ? dateA - dateB : dateB - dateA;
        });

        todos.forEach(todo => todoList.appendChild(todo)); // Reorder the list
    }

    // Bulk actions functionality
    function toggleSelectAll(listType) {
        let selector, buttonId;

        if (listType === 'active') {
            selector = '.todo-select';
            buttonId = 'select-all-active';
        } else if (listType === 'completed') {
            selector = '.todo-select-completed';
            buttonId = 'select-all-completed';
        } else if (listType === 'deleted') {
            selector = '.todo-select-deleted';
            buttonId = 'select-all-deleted';
        }

        const checkboxes = document.querySelectorAll(selector);
        const button = document.getElementById(buttonId);
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });

        button.textContent = allChecked ? 'Vali kõik' : 'Tühista valik';
    }

    function getSelectedIds(selector) {
        const checkboxes = document.querySelectorAll(selector + ':checked');
        return Array.from(checkboxes).map(cb => cb.dataset.id);
    }

    function bulkComplete() {
        const ids = getSelectedIds('.todo-select');
        if (ids.length === 0) return;

        document.getElementById('bulk-complete-ids').value = ids.join(',');
        document.getElementById('bulk-complete-form').submit();
    }

    function bulkDelete(tab = 'active') {
        let selector = tab === 'active' ? '.todo-select' : '.todo-select-completed';
        const ids = getSelectedIds(selector);
        if (ids.length === 0) return;

        document.getElementById('bulk-delete-ids').value = ids.join(',');
        document.getElementById('bulk-delete-tab').value = tab === 'active' ? 'active-todos' : 'completed-todos';
        document.getElementById('bulk-delete-form').submit();
    }

    function bulkRestore() {
        const ids = getSelectedIds('.todo-select-deleted');
        if (ids.length === 0) return;

        document.getElementById('bulk-restore-ids').value = ids.join(',');
        document.getElementById('bulk-restore-form').submit();
    }

    function bulkPermanentDelete() {
        const ids = getSelectedIds('.todo-select-deleted');
        if (ids.length === 0) return;

        if (confirm('Oled kindel, et soovid valitud ülesanded jäädavalt kustutada?')) {
            document.getElementById('bulk-permanent-delete-ids').value = ids.join(',');
            document.getElementById('bulk-permanent-delete-form').submit();
        }
    }

    // Drag and drop functionality with Sortable.js
    document.addEventListener('DOMContentLoaded', function() {
        const todoList = document.getElementById('todo-list');
        if (todoList) {
            new Sortable(todoList, {
                handle: '.handle',
                animation: 150,
                onEnd: function(evt) {
                    const todoItem = evt.item;
                    const todoId = todoItem.dataset.id;
                    const newPosition = evt.newIndex;

                    // Send the new order to the server
                    fetch('{{ url_for("todo.update_priority") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            todo_id: todoId,
                            new_position: newPosition
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Priority updated successfully');
                        } else {
                            console.error('Failed to update priority');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            });
        }
    });

    // Open the correct tab on page load
    window.onload = function() {
        var tab = "{{ tab }}";
        if (tab) {
            var tabButton = document.querySelector(`.tablink[onclick*="${tab}"]`);
            if (tabButton) {
                tabButton.click();
            }
        }
        sortTodosByDate(); // Apply sorting when page loads
    };

    // Countdown functionality
    function updateCountdown() {
        const targetDate = new Date("March 2, 2025 00:00:00").getTime();
        const now = new Date().getTime();
        const timeLeft = targetDate - now;

        if (timeLeft <= 0) {
            document.getElementById("countdown").innerHTML = "Aeg on käes!";
            return;
        }

        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        document.getElementById("countdown").innerHTML =
            `${days} päeva, ${hours} tundi, ${minutes} minutit, ${seconds} sekundit`;

        setTimeout(updateCountdown, 1000);
    }

    // Initialize countdown if the element exists
    if (document.getElementById("countdown")) {
        updateCountdown();
    }
</script>
<style>
    /* Styles for the bulk actions */
    .bulk-actions {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
    }

    .bulk-actions button {
        padding: 8px 12px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .bulk-actions button:hover {
        background-color: #e0e0e0;
    }

    /* Styles for checkboxes */
    .todo-checkbox {
        display: flex;
        align-items: center;
        margin-right: 10px;
    }

    .todo-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    /* Drag handle */
    .handle {
        cursor: grab;
        padding: 0 10px;
        color: #999;
        font-size: 18px;
    }

    .handle:active {
        cursor: grabbing;
    }

    /* Due date indicators */
    .deadline-indicator {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 8px;
    }

    .deadline-indicator.soon {
        background-color: #FFC107;
        color: #000;
    }

    .deadline-indicator.overdue {
        background-color: #FF5252;
        color: #fff;
    }

    /* Enhanced styling for todo items */
    .todo-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        border-left: 4px solid transparent;
        transition: background-color 0.2s;
    }

    .todo-item.priority-high {
        border-left-color: #FF5252;
    }

    .todo-item.priority-medium {
        border-left-color: #FFC107;
    }

    .todo-item.priority-low {
        border-left-color: #4CAF50;
    }

    .todo-item.due-soon {
        background-color: rgba(255, 193, 7, 0.1);
    }

    .todo-item.overdue {
        background-color: rgba(255, 82, 82, 0.1);
    }

    /* Add Task button styles */
    .add-todo-button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 15px;
        transition: background-color 0.3s;
    }

    .add-todo-button:hover {
        background-color: #3e8e41;
    }

    /* Existing countdown styles */
    #countdown {
        font-size: 24px;
        font-weight: bold;
        color: white;
        background: linear-gradient(135deg, #ff7e5f, #feb47b);
        padding: 15px 20px;
        border-radius: 10px;
        text-align: center;
        max-width: 300px;
        margin: 20px auto;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        animation: pulse 1.5s infinite alternate;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.05);
            opacity: 0.9;
        }
    }
</style>
{% endblock %}