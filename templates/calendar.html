{% extends "base.html" %}

{% block content %}
<!-- Calendar View Controls -->
<div class="calendar-controls">
    <div class="view-toggle">
        <button id="month-view-btn" class="view-btn active" onclick="switchView('month')">Kuu vaade</button>
        <button id="week-view-btn" class="view-btn" onclick="switchView('week')">Nädala vaade</button>
        <button id="day-view-btn" class="view-btn" onclick="switchView('day')">Päeva vaade</button>
    </div>
    
    <div class="date-navigation">
        <button id="prev-btn" onclick="navigate('prev')">&lt; Eelmine</button>
        <h2 id="current-date-display">Märts 2025</h2>
        <button id="next-btn" onclick="navigate('next')">Järgmine &gt;</button>
        <button id="today-btn" onclick="goToToday()">Täna</button>
    </div>
    
    <div class="category-filter">
        <label for="category-select">Kategooria:</label>
        <select id="category-select" onchange="filterByCategory()">
            <option value="all">Kõik</option>
            <option value="personal">Isiklik</option>
            <option value="work">Töö</option>
            <option value="family">Pere</option>
            <option value="health">Tervis</option>
            <option value="other">Muu</option>
        </select>
    </div>
    
    <button onclick="openAddEventModal()" class="add-event-button">Lisa üritus</button>
</div>

<!-- Calendar Views Container -->
<div class="calendar-container">
    <!-- Month View (Default) -->
    <div id="month-view" class="calendar-view active">
        <div class="weekday-header">
            <div>E</div>
            <div>T</div>
            <div>K</div>
            <div>N</div>
            <div>R</div>
            <div>L</div>
            <div>P</div>
        </div>
        <div id="month-grid" class="month-grid">
            <!-- Days will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Week View -->
    <div id="week-view" class="calendar-view">
        <div class="time-column">
            {% for hour in range(0, 24) %}
                <div class="hour-slot">{{ hour }}:00</div>
            {% endfor %}
        </div>
        <div id="week-grid" class="week-grid">
            <!-- Days and events will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Day View -->
    <div id="day-view" class="calendar-view">
        <div class="time-column">
            {% for hour in range(0, 24) %}
                <div class="hour-slot">{{ hour }}:00</div>
            {% endfor %}
        </div>
        <div id="day-grid" class="day-grid">
            <!-- Events will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Category Legend -->
<div class="category-legend">
    <div class="legend-title">Sündmuse kategooriad:</div>
    <div class="legend-item">
        <div class="color-box category-personal"></div>
        <span>Isiklik</span>
    </div>
    <div class="legend-item">
        <div class="color-box category-work"></div>
        <span>Töö</span>
    </div>
    <div class="legend-item">
        <div class="color-box category-family"></div>
        <span>Pere</span>
    </div>
    <div class="legend-item">
        <div class="color-box category-health"></div>
        <span>Tervis</span>
    </div>
    <div class="legend-item">
        <div class="color-box category-other"></div>
        <span>Muu</span>
    </div>
</div>

<!-- Add Event Modal -->
<div id="add-event-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddEventModal()">&times;</span>
        <h2>Lisa uus sündmus</h2>
        <form id="add-event-form" method="POST" action="{{ url_for('calendar.add_event') }}">
            <div class="form-group">
                <label for="event-title">Pealkiri:</label>
                <input type="text" id="event-title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="event-description">Kirjeldus:</label>
                <textarea id="event-description" name="description"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group half">
                    <label for="event-start-date">Algus kuupäev:</label>
                    <input type="date" id="event-start-date" name="start_date" required>
                </div>
                <div class="form-group half">
                    <label for="event-start-time">Algus aeg:</label>
                    <input type="time" id="event-start-time" name="start_time">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group half">
                    <label for="event-end-date">Lõpu kuupäev:</label>
                    <input type="date" id="event-end-date" name="end_date" required>
                </div>
                <div class="form-group half">
                    <label for="event-end-time">Lõpu aeg:</label>
                    <input type="time" id="event-end-time" name="end_time">
                </div>
            </div>
            
            <div class="form-group">
                <label for="event-category">Kategooria:</label>
                <select id="event-category" name="category" required>
                    <option value="personal">Isiklik</option>
                    <option value="work">Töö</option>
                    <option value="family">Pere</option>
                    <option value="health">Tervis</option>
                    <option value="other">Muu</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="event-recurrence">Kordus:</label>
                <select id="event-recurrence" name="recurrence" onchange="toggleRecurrenceOptions()">
                    <option value="none">Ei kordu</option>
                    <option value="daily">Iga päev</option>
                    <option value="weekly">Iga nädal</option>
                    <option value="monthly">Iga kuu</option>
                    <option value="yearly">Iga aasta</option>
                    <option value="custom">Kohandatud...</option>
                </select>
            </div>
            
            <div id="recurrence-options" class="recurrence-options" style="display: none;">
                <div class="form-group">
                    <label for="recurrence-interval">Intervalliga:</label>
                    <input type="number" id="recurrence-interval" name="recurrence_interval" min="1" value="1">
                </div>
                
                <div class="form-group" id="weekday-selector" style="display: none;">
                    <label>Nädalapäevad:</label>
                    <div class="weekday-checkboxes">
                        <label><input type="checkbox" name="weekdays" value="1">E</label>
                        <label><input type="checkbox" name="weekdays" value="2">T</label>
                        <label><input type="checkbox" name="weekdays" value="3">K</label>
                        <label><input type="checkbox" name="weekdays" value="4">N</label>
                        <label><input type="checkbox" name="weekdays" value="5">R</label>
                        <label><input type="checkbox" name="weekdays" value="6">L</label>
                        <label><input type="checkbox" name="weekdays" value="0">P</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recurrence-end">Lõpeb:</label>
                    <select id="recurrence-end" name="recurrence_end" onchange="toggleRecurrenceEndOptions()">
                        <option value="never">Mitte kunagi</option>
                        <option value="after">Pärast korduste arvu</option>
                        <option value="on-date">Kuupäeval</option>
                    </select>
                </div>
                
                <div class="form-group" id="recurrence-count" style="display: none;">
                    <label for="recurrence-count-value">Korduste arv:</label>
                    <input type="number" id="recurrence-count-value" name="recurrence_count" min="1" value="10">
                </div>
                
                <div class="form-group" id="recurrence-until" style="display: none;">
                    <label for="recurrence-until-date">Lõpu kuupäev:</label>
                    <input type="date" id="recurrence-until-date" name="recurrence_until">
                </div>
            </div>
            
            <button type="submit" class="submit-button">Lisa sündmus</button>
        </form>
    </div>
</div>

<!-- Event Details Modal -->
<div id="event-details-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEventDetailsModal()">&times;</span>
        <div id="event-details-header" class="event-details-header">
            <h2 id="event-details-title"></h2>
        </div>
        <div class="event-details-content">
            <p id="event-details-date"></p>
            <p id="event-details-time"></p>
            <p id="event-details-category"></p>
            <p id="event-details-recurrence"></p>
            <div id="event-details-description"></div>
            
            <!-- For recurring events -->
            <div id="recurring-event-options" style="display: none;">
                <h3>Korduvad üritused</h3>
                <div class="recurring-options">
                    <button id="edit-single" onclick="editEvent('single')">Muuda ainult seda kordust</button>
                    <button id="edit-all" onclick="editEvent('all')">Muuda kõiki kordusi</button>
                    <button id="edit-future" onclick="editEvent('future')">Muuda seda ja tulevasi kordusi</button>
                </div>
            </div>
            
            <div class="event-actions">
                <button onclick="editEvent()">Muuda</button>
                <button onclick="deleteEvent()">Kustuta</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Current view and date tracking
    let currentView = 'month';
    let currentDate = new Date();
    let selectedDate = new Date();
    let events = [];

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        fetchEvents();
        updateCalendarDisplay();
    });

    // Fetch events from the server
    function fetchEvents() {
        fetch("/calendar/get_events")
            .then(response => response.json())
            .then(data => {
                events = data;
                // Expand recurring events
                events = expandRecurringEvents(events);
                updateCalendarDisplay();
            })
            .catch(error => console.error('Error fetching events:', error));
    }

    // Expand recurring events into individual instances
    function expandRecurringEvents(eventList) {
        let expandedEvents = [];
        const today = new Date();
        const oneYearLater = new Date();
        oneYearLater.setFullYear(today.getFullYear() + 1);

        eventList.forEach(event => {
            if (event.recurrence === 'none' || !event.recurrence) {
                expandedEvents.push(event);
                return;
            }

            // For recurring events, generate instances
            let startDate = new Date(event.start_date);
            const endDate = event.recurrence_until ? new Date(event.recurrence_until) : oneYearLater;
            const interval = event.recurrence_interval || 1;

            while (startDate <= endDate) {
                // Skip if we've reached the recurring count limit
                if (event.recurrence_end === 'after' &&
                    expandedEvents.filter(e => e.parent_id === event.id).length >= event.recurrence_count) {
                    break;
                }

                // For weekly recurrence, check weekday match
                if (event.recurrence === 'weekly' && event.weekdays && event.weekdays.length > 0) {
                    const dayOfWeek = startDate.getDay();
                    if (!event.weekdays.includes(dayOfWeek.toString())) {
                        // Move to next day
                        startDate.setDate(startDate.getDate() + 1);
                        continue;
                    }
                }

                // Create instance
                const instanceEndDate = new Date(startDate);
                if (event.end_date) {
                    const originalStartDate = new Date(event.start_date);
                    const originalEndDate = new Date(event.end_date);
                    const dateDiff = (originalEndDate - originalStartDate) / (1000 * 60 * 60 * 24);
                    instanceEndDate.setDate(instanceEndDate.getDate() + dateDiff);
                }

                expandedEvents.push({
                    ...event,
                    is_recurring_instance: true,
                    parent_id: event.id,
                    id: event.id + '_' + startDate.toISOString(),
                    start_date: startDate.toISOString().split('T')[0],
                    end_date: instanceEndDate.toISOString().split('T')[0]
                });

                // Move to next date based on recurrence pattern
                switch (event.recurrence) {
                    case 'daily':
                        startDate.setDate(startDate.getDate() + interval);
                        break;
                    case 'weekly':
                        if (event.weekdays && event.weekdays.length > 0) {
                            startDate.setDate(startDate.getDate() + 1);
                        } else {
                            startDate.setDate(startDate.getDate() + (7 * interval));
                        }
                        break;
                    case 'monthly':
                        startDate.setMonth(startDate.getMonth() + interval);
                        break;
                    case 'yearly':
                        startDate.setFullYear(startDate.getFullYear() + interval);
                        break;
                    default:
                        startDate.setDate(startDate.getDate() + 1);
                }
            }
        });

        return expandedEvents;
    }

    // Update calendar based on current view and date
    function updateCalendarDisplay() {
        // Update date display
        updateDateDisplay();

        // Clear previous view data
        clearCalendarView();

        // Render appropriate view
        switch (currentView) {
            case 'month':
                renderMonthView();
                break;
            case 'week':
                renderWeekView();
                break;
            case 'day':
                renderDayView();
                break;
        }
    }

    // Update the date display header
    function updateDateDisplay() {
        const months = ['Jaanuar', 'Veebruar', 'Märts', 'Aprill', 'Mai', 'Juuni', 'Juuli', 'August', 'September', 'Oktoober', 'November', 'Detsember'];
        const weekdays = ['Pühapäev', 'Esmaspäev', 'Teisipäev', 'Kolmapäev', 'Neljapäev', 'Reede', 'Laupäev'];

        let displayText = '';

        switch (currentView) {
            case 'month':
                displayText = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                break;
            case 'week':
                const weekStart = new Date(currentDate);
                const dayOfWeek = currentDate.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Adjust for Monday as first day
                weekStart.setDate(currentDate.getDate() - diff);

                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                // Format: "DD.MM - DD.MM.YYYY"
                if (weekStart.getMonth() === weekEnd.getMonth()) {
                    displayText = `${weekStart.getDate()}.-${weekEnd.getDate()}. ${months[weekStart.getMonth()]} ${weekEnd.getFullYear()}`;
                } else {
                    displayText = `${weekStart.getDate()}. ${months[weekStart.getMonth()]} - ${weekEnd.getDate()}. ${months[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
                }
                break;
            case 'day':
                displayText = `${weekdays[currentDate.getDay()]}, ${currentDate.getDate()}. ${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                break;
        }

        document.getElementById('current-date-display').textContent = displayText;
    }

    // Clear the calendar view
    function clearCalendarView() {
        document.getElementById('month-grid').innerHTML = '';
        document.getElementById('week-grid').innerHTML = '';
        document.getElementById('day-grid').innerHTML = '';
    }

    // Render month view
    function renderMonthView() {
        const monthGrid = document.getElementById('month-grid');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // Get first day of month
        const firstDay = new Date(year, month, 1);
        let startingDay = firstDay.getDay();
        startingDay = startingDay === 0 ? 6 : startingDay - 1; // Adjust for Monday as first day

        // Get number of days in month
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();

        // Get days from previous month
        const prevMonth = new Date(year, month, 0);
        const daysInPrevMonth = prevMonth.getDate();

        // Create day cells
        let dayCount = 1;
        let dayOfNextMonth = 1;

        // Calculate number of rows needed
        const totalDays = startingDay + daysInMonth;
        const rows = Math.ceil(totalDays / 7);

        for (let i = 0; i < rows; i++) {
            const weekRow = document.createElement('div');
            weekRow.className = 'week-row';

            for (let j = 0; j < 7; j++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';

                if (i === 0 && j < startingDay) {
                    // Previous month days
                    const prevMonthDay = daysInPrevMonth - startingDay + j + 1;
                    dayCell.innerHTML = `<div class="day-number other-month">${prevMonthDay}</div>`;
                    dayCell.classList.add('other-month');
                } else if (dayCount > daysInMonth) {
                    // Next month days
                    dayCell.innerHTML = `<div class="day-number other-month">${dayOfNextMonth}</div>`;
                    dayCell.classList.add('other-month');
                    dayOfNextMonth++;
                } else {
                    // Current month days
                    dayCell.innerHTML = `<div class="day-number">${dayCount}</div>`;

                    // Check if this is today
                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && dayCount === today.getDate()) {
                        dayCell.classList.add('today');
                    }

                    // Check if this is the selected date
                    if (year === selectedDate.getFullYear() && month === selectedDate.getMonth() && dayCount === selectedDate.getDate()) {
                        dayCell.classList.add('selected');
                    }

                    // Add events for this day
                    const dayString = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayCount).padStart(2, '0')}`;
                    const dayEvents = events.filter(event => {
                        const eventStart = new Date(event.start_date);
                        const eventEnd = event.end_date ? new Date(event.end_date) : new Date(event.start_date);

                        const cellDate = new Date(dayString);
                        return cellDate >= eventStart && cellDate <= eventEnd;
                    });

                    const eventsContainer = document.createElement('div');
                    eventsContainer.className = 'day-events';

                    dayEvents.forEach(event => {
                        const eventElement = document.createElement('div');
                        eventElement.className = `event category-${event.category}`;
                        if (event.is_recurring_instance) {
                            eventElement.classList.add('recurring-event');
                        }

                        eventElement.innerHTML = `<span class="event-title">${event.title}</span>`;
                        eventElement.addEventListener('click', () => showEventDetails(event));

                        eventsContainer.appendChild(eventElement);
                    });

                    dayCell.appendChild(eventsContainer);

                    // Set click handler for day selection
                    dayCell.addEventListener('click', function(e) {
                        if (!e.target.closest('.event')) {
                            selectedDate = new Date(year, month, dayCount);
                            updateCalendarDisplay();
                        }
                    });

                    dayCount++;
                }

                weekRow.appendChild(dayCell);
            }

            monthGrid.appendChild(weekRow);
        }
    }

    // Render week view
    function renderWeekView() {
        const weekGrid = document.getElementById('week-grid');

        // Get start of week (Monday)
        const startOfWeek = new Date(currentDate);
        const dayOfWeek = currentDate.getDay();
        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Adjust for Monday as first day
        startOfWeek.setDate(currentDate.getDate() - diff);

        // Create day columns
        const weekdays = ['Esmaspäev', 'Teisipäev', 'Kolmapäev', 'Neljapäev', 'Reede', 'Laupäev', 'Pühapäev'];

        // Create header row with day names
        const headerRow = document.createElement('div');
        headerRow.className = 'week-header';

        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column-header';

            const dayDate = new Date(startOfWeek);
            dayDate.setDate(startOfWeek.getDate() + i);

            // Check if this is today
            const today = new Date();
            if (dayDate.getDate() === today.getDate() &&
                dayDate.getMonth() === today.getMonth() &&
                dayDate.getFullYear() === today.getFullYear()) {
                dayCol.classList.add('today');
            }

            // Check if this is the selected date
            if (dayDate.getDate() === selectedDate.getDate() &&
                dayDate.getMonth() === selectedDate.getMonth() &&
                dayDate.getFullYear() === selectedDate.getFullYear()) {
                dayCol.classList.add('selected');
            }

            dayCol.innerHTML = `
                <div>${weekdays[i]}</div>
                <div>${dayDate.getDate()}.${dayDate.getMonth() + 1}</div>
            `;

            // Set click handler for day selection
            dayCol.addEventListener('click', function() {
                selectedDate = new Date(dayDate);
                updateCalendarDisplay();
            });

            headerRow.appendChild(dayCol);
        }

        weekGrid.appendChild(headerRow);

        // Create grid with time slots
        const gridContainer = document.createElement('div');
        gridContainer.className = 'week-grid-container';

        for (let i = 0; i < 7; i++) {
            const dayCol = document.createElement('div');
            dayCol.className = 'day-column';

            const dayDate = new Date(startOfWeek);
            dayDate.setDate(startOfWeek.getDate() + i);

            // Check if this is today
            const today = new Date();
            if (dayDate.getDate() === today.getDate() &&
                dayDate.getMonth() === today.getMonth() &&
                dayDate.getFullYear() === today.getFullYear()) {
                dayCol.classList.add('today');
            }

            // Create hour slots
            for (let hour = 0; hour < 24; hour++) {
                const hourSlot = document.createElement('div');
                hourSlot.className = 'hour-cell';
                hourSlot.dataset.hour = hour;

                // Add click handler for adding events
                hourSlot.addEventListener('click', function() {
                    const clickedDate = new Date(dayDate);
                    clickedDate.setHours(hour);
                    openAddEventModal(clickedDate);
                });

                dayCol.appendChild(hourSlot);
            }

            // Add events for this day
            const dayString = `${dayDate.getFullYear()}-${String(dayDate.getMonth() + 1).padStart(2, '0')}-${String(dayDate.getDate()).padStart(2, '0')}`;
            const dayEvents = events.filter(event => {
                const eventStart = new Date(event.start_date);
                const eventEnd = event.end_date ? new Date(event.end_date) : new Date(event.start_date);

                const cellDate = new Date(dayString);
                return cellDate >= eventStart && cellDate <= eventEnd;
            });

            dayEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `week-event category-${event.category}`;
                if (event.is_recurring_instance) {
                    eventElement.classList.add('recurring-event');
                }

                // Calculate position based on time
                let startHour = 0;
                let endHour = 1;

                if (event.start_time) {
                    const [hours, minutes] = event.start_time.split(':');
                    startHour = parseInt(hours) + parseInt(minutes) / 60;
                }

                if (event.end_time) {
                    const [hours, minutes] = event.end_time.split(':');
                    endHour = parseInt(hours) + parseInt(minutes) / 60;
                } else {
                    endHour = startHour + 1;
                }

                // Adjust for multi-day events
                const eventStart = new Date(event.start_date);
                const eventEnd = new Date(event.end_date || event.start_date);

                if (dayDate.getTime() > eventStart.getTime()) {
                    startHour = 0;
                }

                if (dayDate.getTime() < eventEnd.getTime() && dayDate.getDate() !== eventEnd.getDate()) {
                    endHour = 24;
                }

                const top = (startHour / 24) * 100;
                const height = ((endHour - startHour) / 24) * 100;

                eventElement.style.top = `${top}%`;
                eventElement.style.height = `${height}%`;

                eventElement.innerHTML = `<span class="event-title">${event.title}</span>`;
                eventElement.addEventListener('click', () => showEventDetails(event));

                dayCol.appendChild(eventElement);
            });

            gridContainer.appendChild(dayCol);
        }

        weekGrid.appendChild(gridContainer);
    }

    // Render day view
    function renderDayView() {
        const dayGrid = document.getElementById('day-grid');
        const dayColumn = document.createElement('div');
        dayColumn.className = 'day-column full-width';

        // Create hour slots
        for (let hour = 0; hour < 24; hour++) {
            const hourSlot = document.createElement('div');
            hourSlot.className = 'hour-cell';
            hourSlot.dataset.hour = hour;

            // Add click handler for adding events
            hourSlot.addEventListener('click', function() {
                const clickedDate = new Date(currentDate);
                clickedDate.setHours(hour);
                openAddEventModal(clickedDate);
            });

            dayColumn.appendChild(hourSlot);
        }

        // Add events for this day
        const dayString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
        const dayEvents = events.filter(event => {
            const eventStart = new Date(event.start_date);
            const eventEnd = event.end_date ? new Date(event.end_date) : new Date(event.start_date);

            const cellDate = new Date(dayString);
            return cellDate >= eventStart && cellDate <= eventEnd;
        });

        dayEvents.forEach(event => {
            const eventElement = document.createElement('div');
            eventElement.className = `day-event category-${event.category}`;
            if (event.is_recurring_instance) {
                eventElement.classList.add('recurring-event');
            }

            // Calculate position based on time
            let startHour = 0;
            let endHour = 1;

            if (event.start_time) {
                const [hours, minutes] = event.start_time.split(':');
                startHour = parseInt(hours) + parseInt(minutes) / 60;
            }

            if (event.end_time) {
                const [hours, minutes] = event.end_time.split(':');
                endHour = parseInt(hours) + parseInt(minutes) / 60;
            } else {
                endHour = startHour + 1;
            }

            const top = (startHour / 24) * 100;
            const height = ((endHour - startHour) / 24) * 100;

            eventElement.style.top = `${top}%`;
            eventElement.style.height = `${height}%`;

            eventElement.innerHTML = `
                <span class="event-title">${event.title}</span>
                <span class="event-time">${event.start_time || ''} - ${event.end_time || ''}</span>
            `;
            eventElement.addEventListener('click', () => showEventDetails(event));

            dayColumn.appendChild(eventElement);
        });

        dayGrid.appendChild(dayColumn);
    }

    // Switch between calendar views
    function switchView(view) {
        currentView = view;

        // Update active button
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`${view}-view-btn`).classList.add('active');

        // Hide all views
        document.querySelectorAll('.calendar-view').forEach(view => {
            view.classList.remove('active');
        });

        // Show selected view
        document.getElementById(`${view}-view`).classList.add('active');

        updateCalendarDisplay();
    }

    // Navigate between time periods
    function navigate(direction) {
        switch (currentView) {
            case 'month':
                if (direction === 'prev') {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                } else {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                break;
            case 'week':
                if (direction === 'prev') {
                    currentDate.setDate(currentDate.getDate() - 7);
                } else {
                    currentDate.setDate(currentDate.getDate() + 7);
                }
                break;
            case 'day':
                if (direction === 'prev') {
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                break;
        }

        updateCalendarDisplay();
    }

    // Go to today
    function goToToday() {
        currentDate = new Date();
        selectedDate = new Date();
        updateCalendarDisplay();
    }

    // Filter events by category
    function filterByCategory() {
        const category = document.getElementById('category-select').value;

        if (category === 'all') {
            // Show all events
            document.querySelectorAll('.event, .week-event, .day-event').forEach(event => {
                event.style.display = 'block';
            });
        } else {
            // Show only selected category
            document.querySelectorAll('.event, .week-event, .day-event').forEach(event => {
                if (event.classList.contains(`category-${category}`)) {
                    event.style.display = 'block';
                } else {
                    event.style.display = 'none';
                }
            });
        }
    }

    // Add Event Modal Functions
    function openAddEventModal(date) {
        const modal = document.getElementById('add-event-modal');
        modal.style.display = 'block';

        // Pre-fill date if provided
        if (date) {
            document.getElementById('event-start-date').value = formatDateForInput(date);
            document.getElementById('event-end-date').value = formatDateForInput(date);

            // Pre-fill time if available
            if (date.getHours()) {
                const formattedHour = String(date.getHours()).padStart(2, '0');
                const formattedMinutes = String(date.getMinutes()).padStart(2, '0');
                document.getElementById('event-start-time').value = `${formattedHour}:${formattedMinutes}`;

                // Default end time to 1 hour later
                const endDate = new Date(date);
                endDate.setHours(endDate.getHours() + 1);
                const formattedEndHour = String(endDate.getHours()).padStart(2, '0');
                const formattedEndMinutes = String(endDate.getMinutes()).padStart(2, '0');
                document.getElementById('event-end-time').value = `${formattedEndHour}:${formattedEndMinutes}`;
            }
        } else {
            // Set default start/end date to selected date
            document.getElementById('event-start-date').value = formatDateForInput(selectedDate);
            document.getElementById('event-end-date').value = formatDateForInput(selectedDate);
        }
    }

    function closeAddEventModal() {
        document.getElementById('add-event-modal').style.display = 'none';
    }

    // Event Details Modal Functions
    function showEventDetails(event) {
        const modal = document.getElementById('event-details-modal');
        const header = document.getElementById('event-details-header');

        // Set event title and category class
        document.getElementById('event-details-title').textContent = event.title;
        header.className = `event-details-header category-${event.category}`;

        // Format dates
        const startDate = new Date(event.start_date);
        const endDate = event.end_date ? new Date(event.end_date) : startDate;

        const formatOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        let dateText = startDate.toLocaleDateString('et-EE', formatOptions);

        if (event.end_date && event.end_date !== event.start_date) {
            dateText += ` - ${endDate.toLocaleDateString('et-EE', formatOptions)}`;
        }

        document.getElementById('event-details-date').textContent = dateText;

        // Format times
        let timeText = '';
        if (event.start_time) {
            timeText = event.start_time;
            if (event.end_time) {
                timeText += ` - ${event.end_time}`;
            }
            document.getElementById('event-details-time').textContent = timeText;
            document.getElementById('event-details-time').style.display = 'block';
        } else {
            document.getElementById('event-details-time').style.display = 'none';
        }

        // Set category
        const categories = {
            'personal': 'Isiklik',
            'work': 'Töö',
            'family': 'Pere',
            'health': 'Tervis',
            'other': 'Muu'
        };
        document.getElementById('event-details-category').textContent = `Kategooria: ${categories[event.category] || event.category}`;

        // Set recurrence info
        const recurrenceText = formatRecurrenceText(event);
        if (recurrenceText) {
            document.getElementById('event-details-recurrence').textContent = recurrenceText;
            document.getElementById('event-details-recurrence').style.display = 'block';
        } else {
            document.getElementById('event-details-recurrence').style.display = 'none';
        }

        // Set description
        document.getElementById('event-details-description').textContent = event.description || 'Kirjeldus puudub';

        // Show recurring event options if applicable
        if (event.is_recurring_instance) {
            document.getElementById('recurring-event-options').style.display = 'block';
        } else {
            document.getElementById('recurring-event-options').style.display = 'none';
        }

        // Store current event ID for edit/delete operations
        modal.dataset.eventId = event.is_recurring_instance ? event.parent_id : event.id;
        modal.dataset.eventInstanceId = event.is_recurring_instance ? event.id : null;

        modal.style.display = 'block';
    }

    function closeEventDetailsModal() {
        document.getElementById('event-details-modal').style.display = 'none';
    }

    // Format recurrence text
    function formatRecurrenceText(event) {
        if (!event.recurrence || event.recurrence === 'none') {
            return '';
        }

        const recurrenceTypes = {
            'daily': 'Iga päev',
            'weekly': 'Iga nädal',
            'monthly': 'Iga kuu',
            'yearly': 'Iga aasta',
            'custom': 'Kohandatud'
        };

        let text = recurrenceTypes[event.recurrence] || 'Korduv';

        if (event.recurrence_interval && event.recurrence_interval > 1) {
            text = text.replace('Iga', `Iga ${event.recurrence_interval}`);
        }

        if (event.weekdays && event.weekdays.length > 0 && event.recurrence === 'weekly') {
            const weekdayNames = {
                '0': 'P', '1': 'E', '2': 'T', '3': 'K', '4': 'N', '5': 'R', '6': 'L'
            };

            const weekdayText = event.weekdays.map(day => weekdayNames[day]).join(', ');
            text += ` (${weekdayText})`;
        }

        if (event.recurrence_end === 'after' && event.recurrence_count) {
            text += `, ${event.recurrence_count} korda`;
        } else if (event.recurrence_end === 'on-date' && event.recurrence_until) {
            const untilDate = new Date(event.recurrence_until);
            text += `, kuni ${untilDate.toLocaleDateString('et-EE')}`;
        }

        return `Kordus: ${text}`;
    }

    // Helper functions for recurrence form
    function toggleRecurrenceOptions() {
        const recurrenceType = document.getElementById('event-recurrence').value;
        const recurrenceOptions = document.getElementById('recurrence-options');
        const weekdaySelector = document.getElementById('weekday-selector');

        if (recurrenceType === 'none') {
            recurrenceOptions.style.display = 'none';
        } else {
            recurrenceOptions.style.display = 'block';

            // Show weekday selector only for weekly recurrence
            if (recurrenceType === 'weekly') {
                weekdaySelector.style.display = 'block';
            } else {
                weekdaySelector.style.display = 'none';
            }
        }
    }

    function toggleRecurrenceEndOptions() {
        const recurrenceEnd = document.getElementById('recurrence-end').value;
        const countContainer = document.getElementById('recurrence-count');
        const untilContainer = document.getElementById('recurrence-until');

        if (recurrenceEnd === 'after') {
            countContainer.style.display = 'block';
            untilContainer.style.display = 'none';
        } else if (recurrenceEnd === 'on-date') {
            countContainer.style.display = 'none';
            untilContainer.style.display = 'block';
        } else {
            countContainer.style.display = 'none';
            untilContainer.style.display = 'none';
        }
    }

    // Edit and Delete Event Functions
    function editEvent(scope) {
        const modal = document.getElementById('event-details-modal');
        const eventId = modal.dataset.eventId;
        const instanceId = modal.dataset.eventInstanceId;

        // Redirect to edit form with appropriate params
        if (scope) {
            window.location.href = `/calendar/edit_event/${eventId}?scope=${scope}&instance=${instanceId}`;
        } else {
            window.location.href = `/calendar/edit_event/${eventId}`;
        }
    }

    function deleteEvent() {
        if (confirm('Kas oled kindel, et soovid sündmuse kustutada?')) {
            const modal = document.getElementById('event-details-modal');
            const eventId = modal.dataset.eventId;

            window.location.href = `/calendar/delete_event/${eventId}`;
        }
    }

    // Helper function to format date for input field
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const addEventModal = document.getElementById('add-event-modal');
        if (event.target === addEventModal) {
            closeAddEventModal();
        }
        
        const eventDetailsModal = document.getElementById('event-details-modal');
        if (event.target === eventDetailsModal) {
            closeEventDetailsModal();
        }
    }
</script>

<style>
    /* Calendar Controls */
    .calendar-controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 15px;
    }
    
    .view-toggle, .date-navigation, .category-filter {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .view-btn, #prev-btn, #next-btn, #today-btn, .add-event-button {
        padding: 8px 12px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .view-btn:hover, #prev-btn:hover, #next-btn:hover, #today-btn:hover, .add-event-button:hover {
        background-color: #e0e0e0;
    }
    
    .view-btn.active {
        background-color: #4CAF50;
        color: white;
    }
    
    .add-event-button {
        background-color: #4CAF50;
        color: white;
    }
    
    .add-event-button:hover {
        background-color: #45a049;
    }
    
    #current-date-display {
        font-size: 1.2em;
        font-weight: bold;
        margin: 0 10px;
    }
    
    /* Calendar Views */
    .calendar-container {
        position: relative;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
    }
    
    .calendar-view {
        display: none;
    }
    
    .calendar-view.active {
        display: block;
    }
    
    /* Month View */
    .weekday-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        text-align: center;
    }
    
    .weekday-header div {
        padding: 10px;
    }
    
    .month-grid {
        display: flex;
        flex-direction: column;
    }
    
    .week-row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        border-bottom: 1px solid #ddd;
    }
    
    .week-row:last-child {
        border-bottom: none;
    }
    
    .day-cell {
        min-height: 100px;
        border-right: 1px solid #ddd;
        padding: 5px;
        position: relative;
    }
    
    .day-cell:last-child {
        border-right: none;
    }
    
    .day-number {
        font-weight: bold;
        padding: 2px 5px;
        margin-bottom: 5px;
    }
    
    .other-month {
        color: #aaa;
    }
    
    .today {
        background-color: #f8f9fa;
    }
    
    .today .day-number {
        background-color: #4CAF50;
        color: white;
        border-radius: 50%;
        display: inline-block;
        width: 25px;
        height: 25px;
        text-align: center;
        line-height: 25px;
    }
    
    .selected {
        background-color: #e8f5e9;
    }
    
    .day-events {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    /* Week and Day Views */
    .time-column {
        position: absolute;
        width: 60px;
        top: 0;
        bottom: 0;
        left: 0;
        background-color: #f5f5f5;
        border-right: 1px solid #ddd;
        z-index: 1;
    }
    
    .hour-slot {
        height: 50px;
        padding: 5px;
        border-bottom: 1px solid #ddd;
        font-size: 0.8em;
        text-align: right;
        padding-right: 10px;
    }
    
    .week-grid, .day-grid {
        margin-left: 60px;
        position: relative;
    }
    
    .week-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        text-align: center;
    }
    
    .day-column-header {
        padding: 10px;
        font-weight: bold;
        border-right: 1px solid #ddd;
    }
    
    .day-column-header:last-child {
        border-right: none;
    }
    
    .week-grid-container {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        height: 1200px; /* 24 hours * 50px */
    }
    
    .day-column {
        position: relative;
        border-right: 1px solid #ddd;
        height: 100%;
    }
    
    .day-column:last-child {
        border-right: none;
    }
    
    .day-column.full-width {
        width: 100%;
    }
    
    .hour-cell {
        height: 50px;
        border-bottom: 1px solid #eee;
    }
    
    /* Events */
    .event, .week-event, .day-event {
        margin-bottom: 2px;
        padding: 2px 5px;
        border-radius: 3px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .event:hover, .week-event:hover, .day-event:hover {
        filter: brightness(0.95);
    }
    
    .week-event, .day-event {
        position: absolute;
        left: 0;
        right: 0;
        margin: 1px;
        padding: 3px 5px;
        z-index: 2;
    }
    
    .event-title {
        font-weight: bold;
        font-size: 0.9em;
    }
    
    .event-time {
        font-size: 0.8em;
        opacity: 0.8;
    }
    
    .recurring-event {
        border-left: 4px solid rgba(255, 255, 255, 0.5);
    }
    
    /* Category Colors */
    .category-personal {
        background-color: #4FC3F7; /* Light blue */
        color: #fff;
    }
    
    .category-work {
        background-color: #FF7043; /* Orange */
        color: #fff;
    }
    
    .category-family {
        background-color: #AED581; /* Light green */
        color: #000;
    }
    
    .category-health {
        background-color: #EC407A; /* Pink */
        color: #fff;
    }
    
    .category-other {
        background-color: #9575CD; /* Purple */
        color: #fff;
    }
    
    /* Category Legend */
    .category-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 20px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
    }
    
    .legend-title {
        font-weight: bold;
        margin-right: 10px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .color-box {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    /* Modals */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
    }
    
    /* Form styling */
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
    }
    
    .form-group.half {
        flex: 1;
    }
    
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    textarea,
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    
    textarea {
        height: 100px;
        resize: vertical;
    }
    
    .submit-button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .submit-button:hover {
        background-color: #45a049;
    }
    
    /* Recurrence options */
    .weekday-checkboxes {
        display: flex;
        gap: 10px;
        margin-top: 5px;
    }
    
    .weekday-checkboxes label {
        display: flex;
        align-items: center;
        font-weight: normal;
    }
    
    .weekday-checkboxes input {
        margin-right: 3px;
    }
    
    /* Event details modal */
    .event-details-header {
        padding: 15px;
        margin: -20px -20px 15px -20px;
        border-radius: 5px 5px 0 0;
        color: white;
    }
    
    .event-details-content {
        padding: 0 10px;
    }
    
    .event-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .event-actions button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .event-actions button:first-child {
        background-color: #2196F3;
        color: white;
    }
    
    .event-actions button:last-child {
        background-color: #f44336;
        color: white;
    }
    
    /* Recurring event options */
    .recurring-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
    }
    
    .recurring-options button {
        padding: 8px;
        border: 1px solid #ddd;
        background-color: #f5f5f5;
        border-radius: 4px;
        cursor: pointer;
        text-align: left;
    }
    
    .recurring-options button:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}